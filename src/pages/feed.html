<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FLUKER</title>
    <link
      rel="shortcut icon"
      href="{{ url_for('static', filename='images/Logo-Fluker.png') }}"
      type="image/x-icon"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles/styleFeed.css') }}"
    />
  </head>

  <body>
    <!-- Cabeçalho principal: logo, título e menu do usuário -->
    <header>
      <div class="header-left">
        <img
          src="{{ url_for('static', filename='images/logo.png') }}"
          alt="Logo FLUKER"
          class="logo"
        />
        <button class="title-center" onclick="window.location.href='/home'">
        FLUKER
        </button>

      </div>

      <div class="user-menu">
        <!-- Botão de busca de usuários -->
        <div class="search-users-wrapper" onclick="openUserSearchModal()">
          <img
            src="{{ url_for('static', filename='images/Lupa.png') }}"
            alt="Buscar usuários"
            class="icone-busca"
          />
        </div>

        <!-- Sino de notificações com badge de não lidas -->
        <div class="bell-wrapper" onclick="openNotificationsModal()">
          <img
            src="{{ url_for('static', filename='images/sino.png') }}"
            alt="Notificações"
            class="icone-sino"
          />
          <span id="notif-badge" class="notif-badge"></span>
        </div>
        
        <!-- Avatar do usuário com dropdown -->
        <img
          src="{{ url_for('static', filename='images/perfil.jpg') }}"
          alt="Perfil"
          class="perfil-topo"
          onclick="toggleUserMenu()"
        />
        <div class="menu-dropdown hidden" id="user-dropdown">
          <ul>
            <li onclick="goToMyProfile()">Meu Perfil</li>
            <li onclick="logout()">Sair</li>
          </ul>
        </div>
      </div>
    </header>

    <div class="layout">
      <main>
        <!-- Seção de perfil -->
        <section id="perfil" class="content">
          <div class="profile">
            {% if profile_user %}
              <!-- Perfil de outro usuário -->
              <div class="avatar">
                <img
                  src="{{ url_for('static', filename='images/perfil.jpg') }}"
                  alt="Foto de perfil"
                  class="perfil-principal"
                />
              </div>
              <h2>{{ profile_user.username }}</h2>
              
              
              {% if not is_my_profile %}
                {% if are_we_friends %}
                  <p class="friend-status">✅ Amigos</p>
                {% elif has_pending_request %}
                  <p class="friend-status">⏳ Solicitação enviada</p>
                {% else %}
                  <form action="{{ url_for('add_friend', user_id=profile_user.id) }}" method="POST">
                    <button type="submit" class="add-friend-btn">Adicionar Amigo</button>
                  </form>
                {% endif %}
              {% endif %}
              
              <h3>Últimos 3 posts:</h3>
              <div class="posts">
                {% if recent_posts %}
                  {% for post in recent_posts %}
                    <div class="post">
                      <div class="post-header">
                        <small>{{ post.timestamp_display }}</small>
                      </div>
                      <p>{{ post.content }}</p>
                      <div class="post-stats">
                        <span>❤️ {{ post.likes }} curtidas</span>
                      </div>
                    </div>
                  {% endfor %}
                {% else %}
                  <p class="empty">Nenhum post ainda.</p>
                {% endif %}
              </div>
            {% else %}
              <!-- Meu perfil -->
              <div class="avatar">
                <img
                  src="{{ url_for('static', filename='images/perfil.jpg') }}"
                  alt="Foto de perfil"
                  class="perfil-principal"
                />
              </div>
              <h2>{{ username }}</h2>
              
              <h3>Meus últimos 3 posts:</h3>
              <div class="posts">
                {% if recent_posts %}
                  {% for post in recent_posts %}
                    <div class="post">
                      <div class="post-header">
                        <small>{{ post.timestamp_display }}</small>
                      </div>
                      <p>{{ post.content }}</p>
                      <div class="post-stats">
                        <span>❤️ {{ post.likes }} curtidas</span>
                      </div>
                    </div>
                  {% endfor %}
                {% else %}
                  <p class="empty">Você ainda não fez nenhum post.</p>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </section>

        <!-- Feed principal: formulário de novo post + lista de posts -->
        <section id="inicio" class="content active">
          <!-- Solicitações de amizade -->
          {% if friend_requests %}
          <div class="friend-requests">
            <h3>Solicitações de Amizade</h3>
            {% for request in friend_requests %}
            <div class="friend-request">
              <span>{{ request.username }}</span>
              <form action="{{ url_for('accept_friend', user_id=request.user_id) }}" method="POST" style="display: inline;">
                <button type="submit" class="accept-friend-btn">Aceitar</button>
              </form>
            </div>
            {% endfor %}
          </div>
          {% endif %}

          <div class="feed-container">
            <!-- Form de novo post: envia para /postar (POST) -->
            <form
              action="{{ url_for('postar') }}"
              method="POST"
              class="new-post-form"
            >
              <textarea
                name="content"
                rows="3"
                placeholder="Escreva um post..."
                required
              ></textarea>
              <div>
                <button type="submit">Publicar</button>
              </div>
            </form>

            <!-- Lista de posts vinda do backend -->
            <div class="posts">
              {% if posts %} 
                {% for p in posts %}
                <div class="post">
                  <!-- Cabeçalho do post: avatar, nome e timestamp -->
                  <div class="post-header">
                    <img
                      src="{{ url_for('static', filename='images/perfil.jpg') }}"
                      alt="{{ p.author_name }}"
                      class="post-avatar"
                    />
                    <div>
                      <h3>{{ p.author_name }}</h3>
                      <small>{{ p.timestamp_display}}</small>
                    </div>
                  </div>

                  <!-- Conteúdo do post -->
                  <p>{{ p.content }}</p>

                  <!-- Botão de curtir com AJAX -->
                  <div class="like-section">
                    <button class="heart-btn" onclick="toggleCurtida(this, {{ p.id }})">
                      {% set liked = (p.get('likes_by') or '') and (user_id in (p.get('likes_by').split(';'))) %}
                      <img 
                        src="{{ url_for('static', filename=('images/redheart.png' if liked else 'images/coracao.png')) }}" 
                        alt="Curtir" 
                        class="heart-icon"
                      />
                      <span class="like-count" id="like-count-{{ p.id }}">{{ p.likes or 0 }}</span>
                    </button>
                  </div>
                </div>
                {% endfor %} 
              {% else %}
                <p class="empty">Nenhum post ainda. Seja o primeiro a postar ou adicione alguns amigos!</p>
              {% endif %}
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- Botão flutuante para abrir/fechar o chat DM -->
    <button class="chat-button" onclick="toggleChat()">CHAT</button>

    <!-- Caixa de chat (DM) - Só aparece se houver amigos -->
    <div id="chat-box" class="chat-box hidden">
      <div class="chat-header">
        <select id="chat-partner">
          <option value="">Selecione um amigo...</option>
        </select>
      </div>
      <div id="chat-messages" class="chat-messages"></div>
      <div class="chat-input-area">
        <input type="text" id="chat-input" placeholder="Digite uma mensagem..." />
        <button id="chat-send">Enviar</button>
      </div>
    </div>

    <!-- Modal de notificações -->
    <div id="notifications-modal" class="hidden">
      <div id="notifications-modal-backdrop"></div>
      <div
        id="notifications-modal-content"
        role="dialog"
        aria-modal="true"
        aria-labelledby="notifications-modal-title"
      >
        <div
          style="
            display: flex;
            align-items: center;
            justify-content: space-between;
          "
        >
          <h3 id="notifications-modal-title">Notificações</h3>
          <button id="notifications-modal-close" aria-label="Fechar">×</button>
        </div>
        <div id="notifications-list"></div>
        <button id="mark-all-read" style="margin-top: 8px">
          Marcar todas como lidas
        </button>
      </div>
    </div>

    <!-- Modal de busca de usuários -->
    <div id="user-search-modal" class="hidden">
      <div id="user-search-backdrop"></div>
      <div
        id="user-search-content"
        role="dialog"
        aria-modal="true"
        aria-labelledby="user-search-title"
      >
        <div
          style="
            display: flex;
            align-items: center;
            justify-content: space-between;
          "
        >
          <h3 id="user-search-title">Explorar Usuários</h3>
          <button id="user-search-close" aria-label="Fechar">×</button>
        </div>
        <div class="search-box">
          <input
            type="text"
            id="user-search-input"
            placeholder="Buscar por nome..."
          />
          <div id="search-results"></div>
        </div>
      </div>
    </div>

    <!-- Exponho o ID do usuário atual para o JS saber quem é "eu" nas mensagens -->
    <script>
      window.CURRENT_USER_ID = "{{ session.get('user_id') }}";
      window.CURRENT_USERNAME = "{{ session.get('username') }}";
    </script>
    <script src="{{ url_for('static', filename='scripts/script.js') }}"></script>
  </body>
</html>